<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hockey Stat Sheet v1.14</title>

<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body { font-family: system-ui; margin: 0; }
nav { display: flex; background: #111; color: white; }
nav button { flex: 1; padding: 12px; border: none; background: none; color: white; }
nav button.active { background: #333; }
section { display: none; padding: 12px; }
section.active { display: block; }
input, select, button, textarea { margin: 4px 0; padding: 6px; width: 100%; }
.list-item { display:flex; justify-content:space-between; align-items:center; }
.scoreline { font-size: 18px; margin: 8px 0; }
.log { border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px; }
textarea { min-height: 80px; }
h4 { margin-top: 16px; }

table { width:100%; border-collapse: collapse; margin-top:8px; }
th, td { border:1px solid #ccc; padding:4px; font-size:14px; text-align:left; }
th { background:#f0f0f0; }

.tools-box {
  border: 1px solid #ccc;
  padding: 8px;
  margin: 8px 0 12px 0;
  border-radius: 6px;
  background: #fafafa;
}
.tools-box strong { display:block; margin-bottom:6px; }
.tools-box button { margin-top: 6px; }
.small-note { font-size: 12px; color: #555; margin-top: 6px; }

hr { margin: 12px 0; }
</style>
</head>

<body>

<nav>
  <button data-tab="seasons" class="active">Seasons</button>
  <button data-tab="teams">Teams</button>
  <button data-tab="newgame">New Game</button>
  <button data-tab="game">Game</button>
  <button data-tab="boxscore">Box Score</button>
</nav>

<section id="seasons" class="active">
  <h3>Seasons</h3>
  <input id="seasonName" placeholder="Season name">
  <button id="addSeason">Add Season</button>
  <div id="seasonList"></div>
</section>

<section id="teams">
  <h3>Teams</h3>
  <select id="teamSeason"></select>
  <input id="teamName" placeholder="Team name">
  <input id="teamAbbr" placeholder="Abbr">
  <button id="addTeam">Add Team</button>
  <div id="teamList"></div>

  <h4>Roster</h4>

  <div class="tools-box">
    <strong>Roster Tools</strong>
    <button id="exportRosters">Export Rosters</button>
    <button id="importRosters">Import Rosters</button>
    <input type="file" id="importFile" accept=".json" style="display:none;">
    <div class="small-note">
      Import will replace existing seasons/teams/rosters. (Game in progress will not be changed.)
    </div>
  </div>

  <select id="rosterTeam"></select>
  <input id="playerNum" placeholder="#">
  <input id="playerName" placeholder="Player name">
  <select id="playerPos">
    <option value="F">Forward</option>
    <option value="D">Defense</option>
    <option value="G">Goalie</option>
  </select>
  <button id="addPlayer">Add Player</button>
  <div id="rosterList"></div>
</section>

<section id="newgame">
  <h3>New Game</h3>
  <select id="ngSeason"></select>

  <select id="ngAway"><option value="">Away Team</option></select>
  <select id="ngAwayG"></select>

  <select id="ngHome"><option value="">Home Team</option></select>
  <select id="ngHomeG"></select>

  <hr>

  <h4>Game Format</h4>
  <label>Regulation Period Length (minutes)</label>
  <input id="regMinutes" type="number" min="1" max="60" value="20">

  <label>Overtime Length (minutes)</label>
  <input id="otMinutes" type="number" min="1" max="60" value="5">

  <label>Shootout if tied after OT?</label>
  <select id="shootoutEnabled">
    <option value="yes" selected>Yes</option>
    <option value="no">No</option>
  </select>

  <button id="startGame">Start Game</button>

  <div class="small-note">
    v1.14: Period customization restored + player stat system fixed.
  </div>
</section>

<section id="game">
  <h3 id="gameStatus"></h3>

  <div class="scoreline">
    Score: <span id="scoreAway">0</span> – <span id="scoreHome">0</span><br>
    Shots: <span id="shotsAway">0</span> – <span id="shotsHome">0</span>
  </div>

  <h2 id="clock">20:00</h2>
  <button id="clockToggle">Start / Stop</button>
  <button id="clockMinus">−1 min</button>
  <button id="advancePeriod">Advance Period</button>
  <button id="endGame">End Game</button>

  <h4>Add Goal</h4>
  <select id="goalTeam"></select>
  <select id="goalScorer"></select>
  <select id="goalA1"></select>
  <select id="goalA2"></select>
  <select id="goalType">
    <option>EV</option><option>PP</option><option>SH</option><option>EN</option><option>PS</option>
  </select>
  <button id="recordGoal">Record Goal</button>

  <h4>Add Shot</h4>
  <select id="shotTeam"></select>
  <select id="shotPlayer"></select>
  <button id="recordShot">Record Shot</button>

  <h4>Add Penalty</h4>
  <select id="penTeam"></select>
  <select id="penPlayer"></select>
  <select id="penType"></select>
  <input id="penMinutes" type="number">
  <button id="recordPenalty">Record Penalty</button>

  <h4>Faceoff</h4>
  <select id="foTeam">
    <option>Home</option>
    <option>Away</option>
  </select>
  <select id="foResult">
    <option>Win</option>
    <option>Loss</option>
  </select>
  <button id="recordFaceoff">Record Faceoff</button>

  <h4>Game Notes</h4>
  <textarea id="gameNotes"></textarea>

  <div class="log" id="eventLog"></div>
</section>

<section id="boxscore">
  <h3>Box Score</h3>
  <div id="boxScore"></div>
</section>

<script>
const $ = id => document.getElementById(id);

/* ---------- DATA ---------- */
const penaltyTypes = {
  "Tripping":2,"Hooking":2,"Slashing":2,"Interference":2,"Holding":2,
  "Holding the Stick":2,"Cross-checking":2,"Boarding":2,"Charging":2,
  "Elbowing":2,"High-sticking":2,"Roughing":2,"Too Many Men":2,
  "Delay of Game":2,"High-sticking (Double)":4,
  "Fighting":5,"Boarding (Major)":5,"Charging (Major)":5,
  "Misconduct":10,"Game Misconduct":10,"Match Penalty":10
};

let state = JSON.parse(localStorage.getItem("hockeyState")) || {
  seasons: [],
  teams: {},
  rosters: {},
  game: null,
  clock: { seconds:1200, running:false, timer:null }
};

function save(){ localStorage.setItem("hockeyState",JSON.stringify(state)); }

/* ---------- NAV ---------- */
document.querySelectorAll("nav button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("nav button").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
    b.classList.add("active");
    $(b.dataset.tab).classList.add("active");
    if(b.dataset.tab==="boxscore") renderBoxScore();
  };
});

/* ---------- SEASONS ---------- */
addSeason.onclick=()=>{
  if(!seasonName.value) return;
  if(!state.seasons.includes(seasonName.value)){
    state.seasons.push(seasonName.value);
    state.teams[seasonName.value]=[];
  }
  seasonName.value="";
  save(); renderSeasons();
};

function renderSeasons(){
  seasonList.innerHTML="";
  state.seasons.forEach(s=>{
    const d=document.createElement("div");
    d.className="list-item";
    d.innerHTML=`<span>${s}</span>`;
    const del=document.createElement("button");
    del.textContent="Delete";
    del.onclick=()=>{
      state.seasons=state.seasons.filter(x=>x!==s);
      delete state.teams[s];
      save(); renderSeasons(); renderTeams();
    };
    d.appendChild(del); seasonList.appendChild(d);
  });
  teamSeason.innerHTML=ngSeason.innerHTML=
    state.seasons.map(s=>`<option>${s}</option>`).join("");
}

/* ---------- TEAMS ---------- */
addTeam.onclick=()=>{
  const s=teamSeason.value;
  if(!s||!teamName.value) return;
  state.teams[s].push({name:teamName.value,abbr:teamAbbr.value});
  state.rosters[teamName.value]=[];
  teamName.value=teamAbbr.value="";
  save(); renderTeams();
};

function renderTeams(){
  teamList.innerHTML="";
  rosterTeam.innerHTML="";
  ngHome.innerHTML='<option value="">Home Team</option>';
  ngAway.innerHTML='<option value="">Away Team</option>';

  (state.teams[teamSeason.value]||[]).forEach(t=>{
    const d=document.createElement("div");
    d.className="list-item";
    d.innerHTML=`<span>${t.name} (${t.abbr})</span>`;
    const del=document.createElement("button");
    del.textContent="Delete";
    del.onclick=()=>{
      state.teams[teamSeason.value]=state.teams[teamSeason.value].filter(x=>x!==t);
      delete state.rosters[t.name];
      save(); renderTeams();
    };
    d.appendChild(del); teamList.appendChild(d);

    rosterTeam.innerHTML+=`<option>${t.name}</option>`;
    ngHome.innerHTML+=`<option>${t.name}</option>`;
    ngAway.innerHTML+=`<option>${t.name}</option>`;
  });

  renderRoster();
}
teamSeason.onchange=renderTeams;

/* ---------- ROSTER ---------- */
addPlayer.onclick=()=>{
  const t=rosterTeam.value;
  if(!t||!playerName.value) return;

  state.rosters[t].push({
    number:playerNum.value,
    name:playerName.value,
    position:playerPos.value
  });

  playerNum.value=playerName.value="";
  save(); renderRoster();
};

function renderRoster(){
  rosterList.innerHTML="";
  (state.rosters[rosterTeam.value]||[]).forEach(p=>{
    const d=document.createElement("div");
    d.className="list-item";
    d.innerHTML=`<span>#${p.number} ${p.name} (${p.position})</span>`;
    const del=document.createElement("button");
    del.textContent="Delete";
    del.onclick=()=>{
      state.rosters[rosterTeam.value]=state.rosters[rosterTeam.value].filter(x=>x!==p);
      save(); renderRoster();
    };
    d.appendChild(del); rosterList.appendChild(d);
  });
}
rosterTeam.onchange=renderRoster;

/* ---------- GOALIES ---------- */
function populateGoalies(team, sel){
  sel.innerHTML="";
  (state.rosters[team]||[]).filter(p=>p.position==="G")
    .forEach(g=>sel.innerHTML+=`<option>${g.name}</option>`);
}
ngHome.onchange=()=>populateGoalies(ngHome.value,ngHomeG);
ngAway.onchange=()=>populateGoalies(ngAway.value,ngAwayG);

/* ---------- PLAYER STATS (PER GAME) ---------- */
function initPlayerStats(teamName){
  const stats = {};
  (state.rosters[teamName]||[]).forEach(p=>{
    stats[p.name] = { goals:0, assists:0, shots:0, pim:0 };
  });
  return stats;
}

function statObj(teamName, playerName){
  if(!state.game || !state.game.playerStats) return null;
  if(!state.game.playerStats[teamName]) return null;
  return state.game.playerStats[teamName][playerName] || null;
}

/* ---------- GAME HELPERS ---------- */
function formatClock(sec){
  return `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
}

function getCurrentPeriodLabel(){
  if(!state.game) return "";
  if(state.game.phase === "REG"){
    return `Period ${state.game.period}`;
  }
  if(state.game.phase === "OT"){
    return "OT";
  }
  if(state.game.phase === "SO"){
    return "SO";
  }
  return `Period ${state.game.period}`;
}

function setClockToCurrentPhase(){
  if(!state.game) return;

  if(state.game.phase === "REG"){
    state.clock.seconds = state.game.settings.regMinutes * 60;
  } else if(state.game.phase === "OT"){
    state.clock.seconds = state.game.settings.otMinutes * 60;
  } else {
    state.clock.seconds = 0;
  }

  state.clock.running = false;
  clearInterval(state.clock.timer);
  renderClock();
}

function updateGameHeader(){
  if(!state.game) return;
  gameStatus.textContent = `${getCurrentPeriodLabel()} — ${state.game.away} @ ${state.game.home}`;
}

function isTied(){
  return state.game.score.home === state.game.score.away;
}

/* ---------- GAME ---------- */
startGame.onclick=()=>{
  if(!ngHome.value || !ngAway.value){
    alert("Please select Home and Away teams.");
    return;
  }

  const regMin = Math.max(1, Number(regMinutes.value) || 20);
  const otMin  = Math.max(1, Number(otMinutes.value) || 5);
  const soEnabled = shootoutEnabled.value === "yes";

  state.game={
    home:ngHome.value,
    away:ngAway.value,
    homeGoalie: ngHomeG.value || "",
    awayGoalie: ngAwayG.value || "",

    score:{home:0,away:0},
    shots:{home:0,away:0},

    goalieStats:{
      home:{shotsAgainst:0,goalsAgainst:0,saves:0},
      away:{shotsAgainst:0,goalsAgainst:0,saves:0}
    },

    playerStats: {
      [ngHome.value]: initPlayerStats(ngHome.value),
      [ngAway.value]: initPlayerStats(ngAway.value)
    },

    penalties:[],
    goals:[],
    period:1,
    phase:"REG", // REG, OT, SO
    notes:"",
    final:false,

    settings:{
      regMinutes: regMin,
      otMinutes: otMin,
      shootoutEnabled: soEnabled
    }
  };

  setClockToCurrentPhase();

  gameNotes.value="";
  eventLog.innerHTML="";

  save();
  updateScore();
  setupGameSelectors();
  updateGameHeader();

  document.querySelector('[data-tab="game"]').click();
};

/* ---------- CLOCK ---------- */
function renderClock(){
  clock.textContent = formatClock(state.clock.seconds);
}
renderClock();

clockToggle.onclick=()=>{
  if(state.game?.final) return;
  if(state.game?.phase === "SO"){
    alert("Shootout clock not used.");
    return;
  }

  state.clock.running=!state.clock.running;

  if(state.clock.running){
    state.clock.timer=setInterval(()=>{
      if(state.clock.seconds>0){
        state.clock.seconds--;
        renderClock();
      }
    },1000);
  } else {
    clearInterval(state.clock.timer);
  }
};

clockMinus.onclick=()=>{
  state.clock.seconds=Math.max(0,state.clock.seconds-60);
  renderClock();
};

advancePeriod.onclick=()=>{
  if(!state.game || state.game.final) return;

  state.clock.running = false;
  clearInterval(state.clock.timer);

  // REG periods
  if(state.game.phase === "REG"){
    if(state.game.period < 3){
      state.game.period++;
      setClockToCurrentPhase();
      updateGameHeader();
      save();
      return;
    }

    // end of Period 3
    if(state.game.period === 3){
      if(isTied()){
        state.game.phase = "OT";
        setClockToCurrentPhase();
        updateGameHeader();
        save();
        return;
      } else {
        state.game.final = true;
        state.clock.seconds = 0;
        renderClock();
        gameStatus.textContent=`FINAL — ${state.game.away} @ ${state.game.home}`;
        save();
        return;
      }
    }
  }

  // OT
  if(state.game.phase === "OT"){
    if(isTied()){
      if(state.game.settings.shootoutEnabled){
        state.game.phase = "SO";
        state.clock.seconds = 0;
        renderClock();
        updateGameHeader();
        eventLog.innerHTML += `END OT — GAME TIED — SHOOTOUT<br>`;
        save();
        return;
      } else {
        state.game.final = true;
        state.clock.seconds = 0;
        renderClock();
        gameStatus.textContent=`FINAL (TIE) — ${state.game.away} @ ${state.game.home}`;
        save();
        return;
      }
    } else {
      state.game.final = true;
      state.clock.seconds = 0;
      renderClock();
      gameStatus.textContent=`FINAL — ${state.game.away} @ ${state.game.home}`;
      save();
      return;
    }
  }

  // SO
  if(state.game.phase === "SO"){
    alert("Shootout winner entry not implemented yet. Use End Game.");
    return;
  }
};

endGame.onclick=()=>{
  if(!state.game) return;

  state.game.final=true;
  state.clock.running=false;
  clearInterval(state.clock.timer);

  gameStatus.textContent=`FINAL — ${state.game.away} @ ${state.game.home}`;
  save();
};

/* ---------- GAME SELECTORS ---------- */
function setupGameSelectors(){
  goalTeam.innerHTML = shotTeam.innerHTML = penTeam.innerHTML =
    '<option value="home">Home</option><option value="away">Away</option>';

  goalTeam.onchange = ()=>populatePlayersFor("goal");
  shotTeam.onchange = ()=>populatePlayersFor("shot");
  penTeam.onchange  = ()=>populatePlayersFor("penalty");

  penType.innerHTML = Object.keys(penaltyTypes).map(p=>`<option>${p}</option>`).join("");
  penType.onchange = ()=>penMinutes.value=penaltyTypes[penType.value];

  populatePlayersFor("goal");
  populatePlayersFor("shot");
  populatePlayersFor("penalty");
}

function populatePlayersFor(context){
  if(!state.game) return;

  const teamKey =
    context==="goal"    ? goalTeam.value :
    context==="shot"    ? shotTeam.value :
                          penTeam.value;

  const team = state.game[teamKey];
  const list = state.rosters[team] || [];

  const options = `<option></option>` + list.map(p=>`<option>${p.name}</option>`).join("");

  if(context==="goal"){
    goalScorer.innerHTML = options;
    goalA1.innerHTML = options;
    goalA2.innerHTML = options;
  }
  if(context==="shot"){
    shotPlayer.innerHTML = options;
  }
  if(context==="penalty"){
    penPlayer.innerHTML = options;
  }
}

/* ---------- HELPERS ---------- */
function updateScore(){
  scoreHome.textContent=state.game.score.home;
  scoreAway.textContent=state.game.score.away;
  shotsHome.textContent=state.game.shots.home;
  shotsAway.textContent=state.game.shots.away;
}

/* ---------- RECORD EVENTS ---------- */
recordGoal.onclick=()=>{
  if(!state.game || state.game.final) return;

  const key=goalTeam.value;
  const scoringTeam = state.game[key];
  const otherKey = key==="home" ? "away" : "home";

  state.game.score[key]++;

  state.game.goalieStats[otherKey].goalsAgainst++;

  const goalEntry = {
    team: scoringTeam,
    scorer: goalScorer.value,
    a1: goalA1.value,
    a2: goalA2.value,
    type: goalType.value,
    periodLabel: getCurrentPeriodLabel(),
    period: state.game.period,
    time: clock.textContent
  };
  state.game.goals.push(goalEntry);

  if(goalScorer.value){
    const s = statObj(scoringTeam, goalScorer.value);
    if(s) s.goals++;
  }

  if(goalA1.value){
    const a1 = statObj(scoringTeam, goalA1.value);
    if(a1) a1.assists++;
  }

  if(goalA2.value){
    const a2 = statObj(scoringTeam, goalA2.value);
    if(a2) a2.assists++;
  }

  updateScore();
  eventLog.innerHTML+=`${clock.textContent} ${getCurrentPeriodLabel()} GOAL ${goalScorer.value} ${goalType.value}<br>`;
  save();
};

recordShot.onclick=()=>{
  if(!state.game || state.game.final) return;

  const key=shotTeam.value;
  const shootingTeam = state.game[key];
  const otherKey = key==="home" ? "away" : "home";

  state.game.shots[key]++;

  state.game.goalieStats[otherKey].shotsAgainst++;

  state.game.goalieStats[otherKey].saves =
    state.game.goalieStats[otherKey].shotsAgainst - state.game.goalieStats[otherKey].goalsAgainst;

  if(shotPlayer.value){
    const s = statObj(shootingTeam, shotPlayer.value);
    if(s) s.shots++;
  }

  updateScore();
  eventLog.innerHTML+=`${clock.textContent} ${getCurrentPeriodLabel()} SHOT ${shotPlayer.value}<br>`;
  save();
};

recordPenalty.onclick=()=>{
  if(!state.game || state.game.final) return;

  const teamKey=penTeam.value;
  const team=state.game[teamKey];

  const entry = {
    team: team,
    player: penPlayer.value,
    type: penType.value,
    minutes: Number(penMinutes.value),
    periodLabel: getCurrentPeriodLabel(),
    period: state.game.period,
    time: clock.textContent
  };

  state.game.penalties.push(entry);

  if(penPlayer.value){
    const p = statObj(team, penPlayer.value);
    if(p) p.pim += Number(penMinutes.value);
  }

  eventLog.innerHTML+=`${clock.textContent} ${getCurrentPeriodLabel()} PEN ${penPlayer.value} ${penType.value} ${penMinutes.value}m<br>`;
  save();
};

recordFaceoff.onclick=()=>{
  if(!state.game || state.game.final) return;
  eventLog.innerHTML+=`${clock.textContent} ${getCurrentPeriodLabel()} FO ${foResult.value} — ${foTeam.value}<br>`;
  save();
};

gameNotes.oninput=()=>{
  if(state.game){
    state.game.notes=gameNotes.value;
    save();
  }
};

/* ---------- BOX SCORE ---------- */
function renderBoxScore(){
  if(!state.game){
    boxScore.innerHTML="No game";
    return;
  }

  let html = `
    <strong>${state.game.away} @ ${state.game.home}</strong><br>
    Final: ${state.game.score.away} – ${state.game.score.home}<br>
    Shots: ${state.game.shots.away} – ${state.game.shots.home}<br>
    <br>
    <strong>Game Format</strong><br>
    Regulation: ${state.game.settings.regMinutes} min periods<br>
    Overtime: ${state.game.settings.otMinutes} min<br>
    Shootout Enabled: ${state.game.settings.shootoutEnabled ? "Yes" : "No"}<br>
    <br>
  `;

  /* GOAL SUMMARY */
  if(state.game.goals && state.game.goals.length){
    html += `
      <h4>Goal Summary</h4>
      <table>
        <tr>
          <th>Team</th>
          <th>Scorer</th>
          <th>A1</th>
          <th>A2</th>
          <th>Type</th>
          <th>PER</th>
          <th>Time</th>
        </tr>
    `;

    state.game.goals.forEach(g=>{
      const perDisplay = g.periodLabel || g.period;
      html += `
        <tr>
          <td>${g.team}</td>
          <td>${g.scorer}</td>
          <td>${g.a1 || ""}</td>
          <td>${g.a2 || ""}</td>
          <td>${g.type}</td>
          <td>${perDisplay}</td>
          <td>${g.time}</td>
        </tr>
      `;
    });

    html += `</table>`;
  }

  /* PENALTY SUMMARY */
  if(state.game.penalties && state.game.penalties.length){
    html += `
      <h4>Penalty Summary</h4>
      <table>
        <tr>
          <th>Team</th>
          <th>Player</th>
          <th>Penalty</th>
          <th>Min</th>
          <th>PER</th>
          <th>Time</th>
        </tr>
    `;

    state.game.penalties.forEach(p=>{
      const perDisplay = p.periodLabel || p.period;
      html += `
        <tr>
          <td>${p.team}</td>
          <td>${p.player}</td>
          <td>${p.type}</td>
          <td>${p.minutes}</td>
          <td>${perDisplay}</td>
          <td>${p.time}</td>
        </tr>
      `;
    });

    html += `</table>`;
  }

  function skaterTable(teamName){
    let t = `<h4>Skater Stats — ${teamName}</h4>`;
    t += `
      <table>
        <tr>
          <th>Player</th>
          <th>G</th>
          <th>A</th>
          <th>PTS</th>
          <th>SOG</th>
          <th>PIM</th>
        </tr>
    `;

    (state.rosters[teamName]||[]).filter(p=>p.position!=="G").forEach(p=>{
      const ps = state.game.playerStats?.[teamName]?.[p.name] || {goals:0,assists:0,shots:0,pim:0};
      const pts = (ps.goals||0) + (ps.assists||0);

      t += `
        <tr>
          <td>${p.name}</td>
          <td>${ps.goals||0}</td>
          <td>${ps.assists||0}</td>
          <td>${pts}</td>
          <td>${ps.shots||0}</td>
          <td>${ps.pim||0}</td>
        </tr>
      `;
    });

    t += `</table>`;
    return t;
  }

  html += skaterTable(state.game.away);
  html += skaterTable(state.game.home);

  /* GOALIE STATS TABLE */
  html += `<h4>Goalie Stats</h4>`;
  html += `
    <table>
      <tr>
        <th>Team</th>
        <th>Goalie</th>
        <th>SA</th>
        <th>GA</th>
        <th>Saves</th>
        <th>SV%</th>
      </tr>
  `;

  function goalieRow(teamKey){
    const goalieName = teamKey==="home" ? state.game.homeGoalie : state.game.awayGoalie;
    const gs = state.game.goalieStats[teamKey];

    const sa = gs.shotsAgainst || 0;
    const ga = gs.goalsAgainst || 0;
    const saves = sa - ga;

    let svpct = "0.000";
    if(sa > 0){
      svpct = (saves / sa).toFixed(3);
    }

    return `
      <tr>
        <td>${state.game[teamKey]}</td>
        <td>${goalieName || "N/A"}</td>
        <td>${sa}</td>
        <td>${ga}</td>
        <td>${saves}</td>
        <td>${svpct}</td>
      </tr>
    `;
  }

  html += goalieRow("away");
  html += goalieRow("home");

  html += `</table>`;

  html += `
    <br><strong>Notes</strong><br>${state.game.notes||"None"}
  `;

  boxScore.innerHTML = html;
}

/* ---------- EXPORT / IMPORT ROSTERS ---------- */
exportRosters.onclick = ()=>{
  const exportData = {
    seasons: state.seasons,
    teams: state.teams,
    rosters: state.rosters
  };

  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "hockey_rosters_v1.14.json";
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
};

importRosters.onclick = ()=>{
  importFile.value = "";
  importFile.click();
};

importFile.onchange = (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ()=>{
    try {
      const data = JSON.parse(reader.result);

      if(!data.seasons || !data.teams || !data.rosters){
        alert("Invalid file format. Missing seasons/teams/rosters.");
        return;
      }

      const ok = confirm("Import will replace all seasons/teams/rosters. Continue?");
      if(!ok) return;

      state.seasons = data.seasons;
      state.teams = data.teams;
      state.rosters = data.rosters;

      save();
      renderSeasons();
      renderTeams();
      alert("Rosters imported successfully.");

    } catch(err){
      alert("Import failed. File is not valid JSON.");
    }
  };
  reader.readAsText(file);
};

/* ---------- INIT ---------- */
renderSeasons();
renderTeams();
</script>

</body>
</html>